---
title: "Wavelet approaches to synchrony (wsyn) package vignette"
author: "Lawrence Sheppard, Jonathan Walter, Thomas Anderson, Lei Zhao, Daniel Reuman"
date: ""
geometry: "left=1cm,right=1cm,top=2.5cm,bottom=2.8cm"

output: 
  pdf_document:
    number_sections: yes
    keep_tex: yes
    fig_caption: yes
link-citations: True
urlcolor: blue

bibliography: wsynvignette_refs.bib 

vignette: >
  %\VignetteIndexEntry{"Matrix model selection package vignette"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The `wsyn` package provides wavelet-based tools for investigating population synchrony.
Population synchrony is the tendency for population densities measured in different locations
to be correlated in their fluctuations through time [@Liebhold_04].
The basic dataset that `wsyn` helps analyze is one or more time
series of the same variable, measured in different locations at the same times; or 
two or more variables so measured at the same times and locations. Tools are implemented
for describing synchrony and for investigating its causes and consequences. Wavelet 
approaches to synchrony include @Grenfell_01; @Viboud_06; @Keitt_08; @Sheppard_16; 
@Sheppard_17; @Sheppard_18; @Walter_17; @Anderson_18. The focus here is on techniques 
used by @Sheppard_16; @Sheppard_17; @Sheppard_18; @Walter_17; @Anderson_18.
The techniques can also be used for data of the same format representing quantities
not related to populations.
<!--Insert additional references from our work as they come out-->
<!--Insert here a summary of the sections-->

# Preparing the data
\noindent A typical dataset for analysis using `wsyn` is an $N \times T$ matrix of numeric 
values where rows correspond to sampling locations (so the number of sampling locations is $N$)
and columns correspond to evenly spaced times during which sampling was conducted (so the
number of times sampling was conducted is $T$).

## Missing data
\noindent Standard implementations of wavelet trasforms require time series consisting
of measurements taken at evenly spaced times, with no missing data. Most functions provided
in `wsyn` make these same assumptions and throw an error if data are missing. 
The user is left to decide on and implement a reasonable way of filling missing
data. Measures of synchrony can be influenced by data
filling techniques that are based on spatial interpolation. We therefore recommend
that spatially informed filling procedures not be used. We have previously 
used the simple approach of
replacing missing values in a time series by the median of the non-missing values in the
time series [@Sheppard_16]. This approach, and other related simple 
procedures [@Sheppard_16], seem
unlikely to artefactually produce significant synchrony, or coherence relationships with other
variables, but rely on the percentage of missing data being fairly low and may obscure 
detection of synchrony or significant coherence relationships if too many data are 
missing.

## De-meaning, detrending, standardizing variance, and normalizing
\noindent A function `cleandat` is provided that performs a variety of combinations
of data cleaning typically necessary for analyses implemented in `wsyn`, including 
de-meaning, linear detrending, standardization of time series variance, and Box-Cox
transformations to normalize marginal distributions of time series. Most functions in
`wsyn` assume at least that means have been removed from time series, and throw an
error if this is not the case. Approaches based on Fourier surrogate (section \ref{sec:surrog})
require time series with approximately normal marginals.

# The wavelet transform
\noindent The function `wt` implements the complex Morlet wavelet transform on which most
other `wsyn` functions are based. An S3 class is defined for `wt`, and it inherits from the
generic class `tts`. See the help files for the generator functions `wt` and `tts` 
for slot names and other information about these classes.

Background on the wavelet transform is available from many sources, including 
@Addison_02, and we do not recapitulate it. We instead describe the wavelet transform
operationally, and demonstrate the implementation 
of the wavelet transform in `wsyn` using examples from Fig. S2 of @Sheppard_18.
Given a time series $x(t)$, $t=1,\ldots,T$, the wavelet transform $w_\sigma(t)$
of $x(t)$ is a complex-valued function of time, $t=1,\ldots,T$, and timescale,
$\sigma$. The magntiude $|w_\sigma(t)|$ is an estimate of the strength of the
oscillations in $x(t)$ at time $t$ occurring at timescale $\sigma$. The complex
phase of $w_\sigma(t)$ gives the phase of these oscilaltions.

```{r seed_setter_1, echo=F}
set.seed(101)
```

To demonstrate the wavelet transform, start by generating some data. Start with a sine wave of
amplitude $1$ and period $15$ that operates for $t=1,\ldots,100$ but then disappears.
```{r wt_example_1_ts1}
time1<-1:100
time2<-101:200
times<-c(time1,time2)
  
ts1p1<-sin(2*pi*time1/15)
ts1p2<-0*time2
ts1<-c(ts1p1,ts1p2)
  
ts<-ts1
```
Then add a sine wave of amplitude $1$ and period $8$ that operates for $t=101,\ldots,200$
but before that is absent.
```{r wt_example_1_ts2}
ts2p1<-0*time1
ts2p2<-sin(2*pi*time2/8)
ts2<-c(ts2p1,ts2p2)
  
ts<-ts+ts2
```
Then add normally distributed white noise of mean $0$ and standard deviation $0.5$.
```{r wt_example_1_ts3}
ts3<-rnorm(200,mean=0,sd=0.5)
ts<-ts+ts3
```
Now apply the wavelet transform, obtaining an object of class `wt`. Default parameter
values for `scale.min`, `scale.max.input`, `sigma` and `f0` are usually good enough for 
initial data exploration.
```{r wt_example_1_wt}
library(wsyn)
ts<-cleandat(ts,times,clev=1)
wtres<-wt(ts$cdat,times)
class(wtres)
names(wtres)
```
Methods `get_times`, `get_timescales`, `get_values`, and `get_dat` extract the slots. 
Set methods also exist, but these just throw an error since setting individual slots of
a `wt` object will break the relationship between the slots.
There is a `plotmag` method for the `tts` class that plots the magnitude of the transform
against time and timescale.
```{r wt_example_1_plot, results=FALSE}
plotmag(wtres)
```

We can see the oscillations at timescale $15$ for the first hundred time steps, and the 
oscilaltions at timescale $8$ for the last 100 time steps. Because the wavelet transform
is based on convolution of a wavelet function with the time series, times and timescales 
for which the overlap of the wavelet with the time series is insufficient are unreliable
and are omitted. This affects times closer to the edges of the time series, and is the 
reason for the "rocketship nose cone" shape of wavelet plots. More values are omitted 
for longer timescales because long-timescale wavelets overhang the end of the time series
further in the convolution operation. All plots based on wavelet transforms have the same
property.

<!--Insert plotphase demo when possible-->

```{r seed_setter_2, echo=F}
set.seed(201)
```

Now we give a second example, also from Fig. S2 of @Sheppard_18. The frequency
of oscillation of the data geenerated below
changes gradually from $0.2$ cycles per year (timescale 5 years) 
to $0.1$ cycles per year (timescale 10 years).
```{r wt_example_2, results=FALSE}
timeinc<-1 #one sample per year
startfreq<-0.2 #cycles per year
endfreq<-0.1 #cycles per year
times<-1:200
f<-seq(from=startfreq,length.out=length(times),to=endfreq) #frequency for each sample
phaseinc<-2*pi*cumsum(f*timeinc)
t.series<-sin(phaseinc)
t.series<-cleandat(t.series,times,1)$cdat
res<-wt(t.series, times)
plotmag(res)
```

<!--maybe also do a plotphase call when possible?-->

The \code{times} argument to \code{wt} (and several other functions, see below)
is tightly constrained. It must be a numeric vector of unit-spaced times 
(\code{diff(times)} is a vector of 1s) with
no missing entries. It must be the same length as the data and correspond to the
timing of measurement of the data. For the most common use cases, the unit 
spacing of times will be natural in some time unit, i.e., sampling is typically
conducted with frequency once per time unit for some natural time unit (e.g., 
once per year, month, day, week, fortnight). In those cases, \code{timescales}
in output and on plots will have units cycles per time unit for the time unit 
of sampling. Applications with sampling time step
not equal to 1 in some natural unit of time can view the \code{times} vector
as a vector of time steps, rather than times, \emph{per se}, and  
\code{timescales} will be in units of cycles per time step.

The arguments \code{scale.min}, \code{scale.max.input}, \code{sigma}, and \code{f0}
to \code{wt} (and several other functions) are for constructing the timescales
used wavelet analysis. The argument \code{scale.min} is the shortest timescale,
and must be $2$ or greater. Starting from \code{scale.min}, each timescale is 
\code{sigma} times the previous one, up to but not surpassing 
\code{scale.max.input}. The scalloping of wavelet transforms places additional
constraints on the largest timescale examined, independently implemented, 
so choosing larger \code{scale.max.input} will only result in longer timescales
up to the limit of scalloping. The argument $f0$ is the ratio of the period of 
fluctuation to the width of the envelope.
<!--Get Lawrence to add a sentence about f0-->

# Time- and timescale-specific measures of synchrony
\noindent The function `wpmf` 
implements the wavelet phasor 
mean field and the function `wmf` implements the wavelet mean
field. These are techniques for depicting the time and timescale dependence of synchrony,
and are introduced in this section. S3 classes are 
defined for `wmf` and `wpmf`, both of which
inherit from the generic class `tts`. See the help files for the generator functions for 
these classes (`wmf`, `wpmf` and `tts`, respectively) for slot names and other
information about the classes.

## The wavelet phasor mean field
\noindent The wavelet phasor mean field (the `wpmf` function in `wsyn`) depicts the time and 
timescale dependence of phase synchrony of a collection of time series. If $x_n(t)$, 
$n=1,\ldots,N$, $t=1,\ldots,T$ are time series of the same variable measured in $N$ locations
at the same times, and if $w_{n,\sigma}(t)$ is the wavelet transform of $x_n(t)$ and 
$W_{n,\sigma}(t)=\frac{w_{n,\sigma}(t)}{|w_{n,\sigma}(t)|}$ has only the information about
the complex phases of the transform (unit-magnitude complex numbers such as these are called
\emph{phasors}), then the wavelet phasor mean field is 
\begin{equation}
\frac{1}{N} \sum_{n=1}^N W_{n,\sigma}(t).
\end{equation}
For combinations of $t$ and $\sigma$ for which oscillations at time $t$ and timescale
$\sigma$ in the time series $x_n(t)$ have the same phase (they are phase synchronized),
the phasors $W_{n,\sigma}(t)$ will all point in similar directions in the complex plane, and
their sum will be a large-magnitude complex number.
For combinations of $t$ and $\sigma$ for which oscillations at time $t$ and timescale
$\sigma$ in the time series $x_n(t)$ have unrelated phases (they are not phase synchronized),
the phasors $W_{n,\sigma}(t)$ will all point in random, unrelated 
directions in the complex plane, and
their sum will be a small-magnitude complex number. Therefore plotting the magnitude of the
wavelet phasor mean field against time and timescale quantifies the time and timescale
dependence of phase synchrony in the $x_n(t)$. The wavelet phasor mean field, being a mean
of phasors, always has magnitude between $0$ and $1$.

```{r seed_setter_3, echo=F}
set.seed(101)
```

We provide an example based on supplementary figure 1 of @Sheppard_16. A related technique, 
the wavelet mean field (section \ref{sect:wmf}), was used there, but the wavelet phasor mean
field also applies and is demonstrated here. We construct data consisting of time series
measured for 100 time steps in each of 11 locations. The time series have three components.
The first component is a sine wave of amplitude $1$ and period $10$ years for the first
half of the time series, and is a sine wave of amplitude $1$ and period $5$ for the 
second half of the time series. This same signal is present in all $11$ time series and
creates the synchrony among them.
```{r wpmf_example_1_dat_1}
times1<-0:50
times2<-51:100
times<-c(times1,times2)
ts1<-c(sin(2*pi*times1/10),sin(2*pi*times2/5))+1.1
```
The second component is a sine wave of amplitude $1$ and period $3$ years that is 
randomly and independently phase shifted in each of the $11$ time series. The third
component is white noise, independently generated for each time series.
```{r wpmf_example_1_dat_2}
dat<-matrix(NA,11,length(times))
for (counter in 1:dim(dat)[1])
{
  ts2<-3*sin(2*pi*times/3+2*pi*runif(1))+3.1
  ts3<-rnorm(length(times),0,1.5)
  dat[counter,]<-ts1+ts2+ts3    
}
dat<-cleandat(dat,times,1)$cdat
```
The second and third components do not generate synchrony, 
and obscure the synchrony of the first component.
As a result, synchrony cannot be readily detected by visually examining the time series:
```{r wpmf_example_1_plotts}
plot(times,dat[1,]/10+1,type='l',xlab="Time",ylab="Time series index",ylim=c(0,12))
for (counter in 2:dim(dat)[1])
{
  lines(times,dat[counter,]/10+counter)
}
```

Nor can synchrony be readily detected by examining the $55$ pairwise correlation coefficients
between the time series, which are widely distributed and include many values above and below
$0$:
```{r wpmf_example_1_cors}
cmat<-cor(t(dat))
diag(cmat)<-NA
cmat<-as.vector(cmat)
cmat<-cmat[!is.na(cmat)]
hist(cmat,30,xlab="Pearson correlation",ylab="Count")
```

But the wavelet phasor mean field sensitively reveals the synchrony and its time
and timescale structure:
```{r wpmf_example_1, results=FALSE}
res<-wpmf(dat,times,sigmethod="quick")
plotmag(res)
```

The `wpmf` function implements assessment of the statistical significance of 
phase synchrony in three ways, one of which is demonstrated by the contour lines on 
the above plot (which give a $95\%$ confidence level by default - the level can be changed
with the `sigthresh` argument to the `plotmag` method for the `wpmf` class). The method
of significance testing the wavelet phasor mean field plot is controlled with the
`sigmethod` argument to `wpmf`, which can be `quick` (the default), `fft` or `aaft`. The
`quick` method compares the mean field magnitude value for each time and timescale 
separately to a distribution of magnitudes of sums of $N$ random, independent
phasors. 

Each time/timescale
pair is compared independently to the distribution, and the multiple testing problem is
not accounted for, so some time/timescales pairs will come out as showing "significant"
phase synchrony by chance, i.e., false-positive detections of phase synchrony can occur. 
For instance, the small islands of significant synchrony at timescale
approximately $5$ and times about $15$ and $40$ on the above plot are false positives. 

Signficance is based on stochastic generation of magnitudes of sums of random phasors,
so significance contours will differ 
slightly on repeat runs. Increasing the number of ranomizations (argument `nrand` to `wpmf`) 
reduces this variation. 

The `quick` method can be inaccurate for very short 
timescales. The two alternative methods, `fft` and `aaft`, mitigate this problem but
are substantially slower. The `fft` and `aaft` methods are based on surrogate 
datasets (section \ref{sec:surrog})
so are discussed in section \ref{sec:wpmfsignif}.

Examples of the wavelet phasor mean field technique applied to real datasets are in, 
for instance, @Sheppard_18 (their Fig. S1) and @Anderson_18 (their Fig. 4).

## The wavelet mean field \label{sect:wmf}
\noindent The wavelet mean field (the `wmf` function in `wsyn`) depicts the time and 
timescale dependence of synchrony of a collection of time series $x_n(t)$ for 
$n=1,\ldots,N$ and $t=1,\ldots,T$, taking into account both phase synchrony and 
associations through time of magnitudes of oscillations in different time series at
a given timescale. See @Sheppard_16 for a precise mathematical definition. 
The plot is similar in format to a wavelet phasor mean field plot, but
without significance contours:
```{r wmf_example_1, results=FALSE}
res<-wpmf(dat,times)
plotmag(res)
```

The wavelet mean field is a more useful technique than the wavelet phasor mean field 
insofar as it accounts for associations of magnitudes of oscillation, in addition
to phase synchrony, but it is less useful insofar as significance contours are not
available. The wavelet mean field also has some mathematical advantages, described in
@Sheppard_16 and @Sheppard_18. The "wavelet Moran theorem" and other theorems 
described in those references use the wavelet 
mean field, not the wavelet phasro mean field, 
and can be used to help attribute synchrony to particular causes. 
Thus the two techniques are often best used together: 
significance of phase synchrony can be identified with the wavelet phasor mean field,
and then once significance is identified, synchrony can be desribed and studied using
the wavelet mean field. 

Examples of the wavelet mean field applied to real data
are in @Sheppard_16 and @Sheppard_18.

# Coherence 


# Surrogates \label{sec:surrog}
\noindent Some of the text of this section was adapted, with minor modifications only, 
from our earlier work [@Sheppard_16; @Sheppard_18; @Anderson_18]. 

The level of wavelet coherence or spatial wavelet coherence consistent with the null hypothesis that there is no relationship between two variables depends on the spatial and temporal autocorrelation of the data. For instance, two variables that fluctuate regularly at the same frequency and are both highly spatially synchronous will have a phase difference that is highly consistent over time and space, and therefore will have high spatial wavelet coherence, even if they are not related. Two irregular oscillators with low spatial synchrony are less likely to show consistent phase differences over time and space if they are unrelated. We test wavelet coherences and spatial wavelet coherences for significance using resampling schemes based on surrogate datasets that randomize away phase relationship between variables while retaining, to the extent possible, the spatial and temporal autocorrelation properties and the marginal distributions of the time series. We use the widely applied Fourier surrogate and amplitude adjusted Fourier surrogate methods [@Prichard_94; @Schreiber_00], implemented 
in the `surrog` function in `wsyn` and summarized below. Surrogates are also used for 
applications other than measures of coherence (see, e.g., section \ref{sec:wpmfsignif}).

<!--Something about aggregating over ranks to get one p-value for band, after I decide how I 
am going to implement that. Or maybe put it as its own section below?-->

## Fourier surrogates


## Amplitude adjusted Fourier surrogates


## Alternative significance tests for the wavelet phasor mean field \label{sec:wpmfsignif}


# References